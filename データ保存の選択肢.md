# データ保存方法

## 保存の種類と特徴

| 保存先                    | 管理主体 | 保存期間                               | 送信範囲                         | 容量           | 主な用途                                 | 利点                                         | 欠点                                               |
| :------------------------ | :------- | :------------------------------------- | :------------------------------- | :------------- | :--------------------------------------- | :------------------------------------------- | :------------------------------------------------- |
| **Cookie**                | ブラウザ | 設定した期限まで（またはセッション中） | 毎回 HTTP リクエストに同封される | 約 4KB         | ログイン状態・トークン・簡易設定         | サーバーと共有しやすい、古いブラウザでも対応 | セキュリティリスク（盗聴・改ざん）、容量制限       |
| **Session Storage**       | ブラウザ | タブを閉じるまで                       | JS のみアクセス                  | 約 5MB         | 一時的なフォームデータ保持、確認画面など | リロードしても保持、セキュア（他サイト不可） | タブ閉じると消える、サーバー共有不可               |
| **Local Storage**         | ブラウザ | 明示的に削除するまで                   | JS のみアクセス                  | 約 5〜10MB     | 設定・テーマ・カート・お気に入り         | 永続的、簡単に使える、サーバー不要           | 同一ドメイン限定、セキュリティ管理は自己責任       |
| **IndexedDB**             | ブラウザ | 永続的                                 | JS のみアクセス                  | 数百 MB〜数 GB | オフラインアプリ、大量データキャッシュ   | 大容量、高速検索、構造化データ保存可         | 実装複雑、互換性に注意                             |
| **Session（サーバー側）** | サーバー | ログアウト or 有効期限まで             | サーバーのみ                     | 制限なし       | ログイン情報、CSRF トークン              | 安全、サーバーで一元管理                     | 負荷がかかる、スケール時に共有必要                 |
| **データベース（DB）**    | サーバー | 永続的                                 | サーバーのみ                     | 大容量         | アプリ本体のデータ、会員・商品・投稿など | 高信頼、バックアップ可、複数端末共有         | セットアップ・設計が必要、パフォーマンス管理が必要 |

<br><br>

## 用途ごとの選択肢

| 用途                                              | 向いている保存先           | 理由                                     |
| :------------------------------------------------ | :------------------------- | :--------------------------------------- |
| ログイン状態の保持                                | Cookie or サーバー Session | セキュリティが必要（JWT など）           |
| 入力フォームの一時保存（ページ遷移対応）          | Session Storage            | ブラウザで閉じるまで保持すれば十分       |
| フォーム値保持（Livewire で old()不要にするなど） | Session（サーバー）        | PHP 側で検証しやすい、テストも通しやすい |
| テーマ設定や UI カスタム（ダークモードなど）      | Local Storage              | 永続的＆サーバー不要で軽い               |
| カート・お気に入り機能（非ログインユーザー）      | Local Storage              | ユーザー未登録でも保持可能               |
| 投稿・商品・勤怠などアプリ本体のデータ            | DB                         | 検索・集計・共有・バックアップに最適     |
| オフライン Web アプリ（PWA など）                 | IndexedDB                  | 大容量データのキャッシュが可能           |

<br>

### 用途に適した特徴

- LocalStorage...軽い設定・UI 状態保存向け
- SessionStorage...一時的な入力保持向け
- Cookie...ログインやトークン、サーバー通信連携向け
- Session（サーバー）...ユーザー状態管理向け
- DB...アプリの本データ保存
- IndexedDB...PWA・オフライン・大容量用途

<br><br>

## 実装時のフロント or バックエンド

| 処理の場所                                 | 向いている保存対象                 | 管理責任     | 実装例                                 |
| :----------------------------------------- | :--------------------------------- | :----------- | :------------------------------------- |
| **フロントエンド（JS, Livewire, Vue 等）** | 表示設定、未ログイン時の一時データ | クライアント | LocalStorage / SessionStorage / Cookie |
| **バックエンド（Laravel 等）**             | 認証情報・アプリデータ             | サーバー     | Session（server） / DB 保存            |

<br><br>

## セキュリティリスク

| リスク                     | 保存先                       | 対策                                |
| :------------------------- | :--------------------------- | :---------------------------------- |
| XSS（JS でデータ読み取り） | LocalStorage, SessionStorage | 重要情報を保存しない（トークン NG） |
| CSRF（リクエスト改ざん）   | Cookie                       | SameSite 属性・CSRF トークン必須    |
| セッションハイジャック     | サーバー Session             | HTTPS ＋適切な期限設定              |

# 実装方法選択の流れ

## Step1 何を保存したいのかを明確にする

| 種類                   | 例                                       | 保存目的                   |
| :--------------------- | :--------------------------------------- | :------------------------- |
| **業務データ（本体）** | 投稿・商品・勤怠・注文など               | アプリの根幹。永続化が必要 |
| **UI 状態・操作状況**  | モーダル開閉、タブ選択、入力中のフォーム | 一時的・ユーザー体験向上   |
| **設定・好み**         | テーマカラー、言語設定、並び順           | 継続して使うが個人依存     |
| **認証・識別情報**     | ログイン状態、トークン                   | 安全に一時保持が必要       |

<br><br>

## Step2 保持する必要のある期間を考える

| 保持期間                         | 保存先候補                                     |
| :------------------------------- | :--------------------------------------------- |
| ページを閉じたら消えて OK        | SessionStorage（フロント） or サーバー Session |
| 同じ端末で再訪しても保持したい   | LocalStorage or Cookie                         |
| サーバー側で全ユーザー共有・管理 | DB                                             |
| オフライン対応が必要             | IndexedDB                                      |

<br><br>

## Step3 どこで扱うべきか（フロント or バックエンド）を決める

| 観点                        | フロント側で扱う  | サーバー側で扱う     |
| :-------------------------- | :---------------- | :------------------- |
| 即座に反映したい UI の状態  | ✅（JS/Livewire） | ❌                   |
| セキュリティが必要な情報    | ❌                | ✅（Session/DB）     |
| データ共有・検索・履歴      | ❌                | ✅                   |
| UX 改善・パフォーマンス目的 | ✅                | （必要に応じて連携） |

<br><br>

## 一例

| 機能                           | 保存対象                | 保存場所                    | 理由                         |
| :----------------------------- | :---------------------- | :-------------------------- | :--------------------------- |
| 商品出品機能                   | 商品データ              | DB                          | 永続化・検索対象だから       |
| フォーム入力途中でリロード防止 | 入力中データ            | SessionStorage              | ページ内で完結する一時保存   |
| ログイン状態保持               | トークン・セッション ID | Cookie / Session            | サーバーと認証情報共有       |
| ダークモード設定               | ユーザー設定            | LocalStorage（+ DB に同期） | 永続化・端末ごとに維持したい |
| モーダル開閉状態               | UI 状態                 | SessionStorage              | ページごとで完結するため     |

<br><br>

## 保存先選定フローチャート by ChatGPT

```
┌──────────────────────────────┐
│ ① 何を保存したい？             |
└─────┬────────────────────────┘
        │
        ├──▶ 業務データ（商品・投稿・勤怠など）──▶ DB
        │       （アプリの本体データ／永続化・共有が必要）
        │
        ├──▶ 認証・識別情報（ログイン状態・トークンなど）
        │       │
        │       ├── セキュリティ重視 → サーバーSession / Cookie（HTTP only）
        │       └── クライアント保持が必要 → Cookie（有効期限付き）
        │
        ├──▶ 設定・好み（テーマ・並び順・言語など）
        │       │
        │       ├── ログインしていない状態でも保持 → LocalStorage
        │       └── ログインユーザー設定にしたい → DB + 同期
        │
        └──▶ UI状態・入力内容（モーダル・タブ・入力フォームなど）
                │
                ├── ページ離脱で消えてOK → SessionStorage
                └── リロード・再訪でも残したい → LocalStorage
```
