---
tags:
  - DB
---

# データベース設計とは

データベースを構築する前に、データベースの完成図を作ること。  
エクセルやスプレットシートなどの表計算アプリに記述する。

<br><br>

# 正規化

「正規化」＝　１つのテーブルから 2 つ以上のテーブルに分離し、  
データが重複しないようにすること。  
<br>

## 正規化のステップ

「非正規形」→ 第１正規化 →「第１正規形」→ 第２正規化 →「第２正規形」  
→ 第３正規化 →「第３正規形」  
<br>

## 第１正規化

全てのカラムにおいて繰り返し表現になっている部分を取り除く  
<br>

繰り返し表現とは

- 重複しているカラム
- 導出可能なカラム

<br>

### 重複しているカラムの削除

| 注文者 ID | 注文者名 | 商品 ID | 商品名          | 商品 ID | 商品名          |
| --------- | -------- | ------- | --------------- | ------- | --------------- |
| 1         | 田中太郎 | 1       | PHP 入門        | 2       | JavaScript 基礎 |
| 3         | 佐藤祐樹 | 2       | JavaScript 基礎 |         |                 |

<br>
↓ 　　　 ↓ 　　　 ↓  
<br><br>

| 注文者 ID | 注文回数 No | 注文者名 | 商品 ID | 商品名          |
| --------- | ----------- | -------- | ------- | --------------- |
| 1         | 1           | 田中太郎 | 1       | PHP 入門        |
| 1         | 2           | 田中太郎 | 2       | JavaScript 基礎 |
| 3         | 1           | 佐藤祐樹 | 2       | JavaScript 基礎 |

<br>
横のカラムの繰り返しをやめて、各行の長さを揃える。  
<br>

### 導出可能なカラムの削除

| 商品名          | 単価 | 数量 | 合計金額 | 消費税 |
| --------------- | ---- | ---- | -------- | ------ |
| PHP 入門        | 1800 | 1    | 1800     | 180    |
| JavaScript 基礎 | 1500 | 2    | 3000     | 300    |
| JavaScript 基礎 | 1500 | 1    | 1500     | 150    |

<br>
↓　　　↓　　　↓
<br><br>

| 商品名          | 単価 | 数量 |
| --------------- | ---- | ---- |
| PHP 入門        | 1800 | 1    |
| JavaScript 基礎 | 1500 | 2    |
| JavaScript 基礎 | 1500 | 1    |

<br>
「導出カラム」＝　他のカラムの値から自動的に値を特定することが出来るカラム  
<br>
例）消費税は合計金額×10％、合計金額は単価と数量から値を求めることが出来るため削除。  
<br>

## 第２正規化

第１正規化された表から、「部分関数従属」している列を切り出す。  
「部分関数従属」＝　主キーを構成する一部のカラムから、それ以外のカラムの値が決まる状態。  
<br>

| 注文者 ID | 注文回数 No | 注文者名 | 商品 ID | 商品名               |
| --------- | ----------- | -------- | ------- | -------------------- |
| 1         | 1           | 田中太郎 | 1       | PHP 入門             |
| 1         | 2           | 田中太郎 | 2       | JavaScript 基礎      |
| 3         | 1           | 佐藤祐樹 | 2       | JavaScript 基礎      |
| ~         | ~           | ~        | ~       | ~                    |
| 1         | 100         | 田中太郎 | 123     | ブロックチェーン入門 |

<br>
↓　　　↓　　　↓
<br><br>

- 注文履歴テーブル
  |注文者 ID| 注文回数 No| 商品 ID| 商品名|
  |-------|------------|------|-------|
  |1 |1 |1 |PHP 入門|
  |1| 2| 2| JavaScript 基礎|
  |3 |1 |2 |JavaScript 基礎|
  |~| ~| ~| ~|
  |1| 100| 123| ブロックチェーン入門|
  <br>

- 会員テーブル
  |注文者 ID| 注文者名|
  |-------|----------|
  |1 |田中太郎|
  |3| 佐藤祐樹|
  <br><br>
  注文者 ID から注文者の値が決まる（常に値がペアになっている）ため、２つのカラムを切り出して、別の表に移す。

<br>

## 第３正規化

第２正規化された表から推移関数従属性を排除する。  
「推移関数従属性」＝　主キー以外のあるカラムが決まると、その他のカラムの値が特定される状態。  
<br>
上記で第２正規化された表では、主キーではない商品 ID から商品名を特定することが出来るため、さらに分離してテーブルを作成する。  
<br>

- 注文履歴テーブル
  |注文者 ID| 注文回数 No| 商品 ID|
  |-------|------------|------|
  |1 |1 |1|
  |1| 2| 2|
  |3 |1 |2|
  <br>

* 会員テーブル
  |注文者 ID| 注文者名|
  |-------|----------|
  |1 |田中太郎|
  |3| 佐藤祐樹|
  <br>

* 教材テーブル
  |商品 ID| 商品名|
  |------|---------|
  |1 |PHP 入門|
  |2| JavaScript 基礎|
  <br>
  第３正規化は他の正規化に比べて自由度が高いが、小さいテーブルを増やしすぎると、効率が悪くなることもある。

<br><br>

# 多重度

- 「エンティティ」＝　データの集まり、実態
- 「リレーション」＝　データ（エンティティ）同士の繋がり
- 「多重度(カーディナリティ)」＝　リレーションのパターン

多重度は基本的に３種類に分かれる

- １対１
- １対多（１対 N）
- 多対多（N 対 N）
  ※N = ０以上のどの数字にもなりうる変数

<br>

## １対１

どちらかのエンティティが分かると、もう片方も特定可能。  
例）個別指導塾の教師と生徒、一夫一妻制の夫婦、電話番号とその形態...  
<br>

## １対多（１対 N）

N が分かると、１のエンティティは特定可能だが、１が分かっても N は特定できない。  
１方向からのみ特定可能な状態  
例）クラス担任と生徒...  
<br>

## 多対多（N 対 N）

双方向にエンティティの特定が不可能な状態  
例）あるクラスを受け持つ複数の教師とそのクラスの生徒...  
<br>

## その他の多重度

可能性として１か N の多重度が 0 になることがある。

- 0 か１対 N
- 0 か N 対 N

<br><br>

# ユースケース図

システムを利用する人の視点で、そのシステムで何が出来るかを示した図。  
<br>
<img src="img/ユースケース図.png" width="500px">
<br>

クライアントとの要求をすり合わせるために作成する。

<br>

## ユースケース図の要素

- アクター
- ユースケース
- システム境界
  <br>

### アクター

システムと相互のやり取りを行う役割の要素  
上の画像では「登録担当者」  
人間だけでなく、ハードウェアや外部システムの場合もある。  
<br>

### ユースケース

アクターがアプリケーションに対して行う操作そのもの  
上の画像では「社員を登録する」「社員を更新する」など  
ユースケース全体を集めると、システム全体の概要が分かる。  
<br>

### システム境界

システムの範囲を示す長方形
上の画像では「人事システム」の長方形  
長方形の内側上部にシステム名を明記  
長方形に囲まれているものは全てシステムの範囲内

<br>

## ユースケースの書き方

1. アクターを洗い出す
2. アクター別のユースケースを洗い出す
3. ユースケース図に落とし込む

<br>
<img src="img/作成手順.png" width="700px">
<br>

VS Code 拡張機能「Draw.io Integration」にてユースケース図を作成する場合、  
下記拡張子で新規ファイル作成。

- .drawio.png
- drawio.svg

<br><br>

# ＥＲ図

## ＥＲ図とは

・「エンティティ」「アトリビュート」「リレーション」「カーディナリティ」と呼ばれる要素で構成される設計図  
・データの構造や関連性を俯瞰的に見やすくするための設計図  
・diagrams.net の その他の図形>ソフトウェア>ER で作成できる  
<br>

## リレーションのカスタマイズ

以下の画像のように歪な形になった場合  
<br>
<img src="img/リレーションNG.png" width="300px">
<br>

リレーションを選択後、右サイドバーの「線」の設定から線の形状を指定できる。  
<br>
<img src="img/リレーション修正.png" width="500px">
<br>

## ＥＲ図の要素

### カーディナリティ(多重度)

「１対１」「１対 N」「N 対 N」など、リレーションの詳細を表現する、  
多重度そのものの概念。  
<br>
ＥＲ図では、カーディナリティを定められた記号（IE 記法）で  
リレーションの始点と終点をつなぐことで表現する。  
<be>
<img src="img/ＥＲ図.png" width="500px">
<br>

### エンティティ

・データのまとまり。  
・上の画像では、「注文テーブル」全体にあたる。  
・データの実態そのものであり、アトリビュートという属性情報を含んでいる。  
・設計をして粒度が細かくなっていくほど、テーブルと同義と考えられる。  
<br>

### リレーション

・エンティティ同士の関係を表現する線。  
・上の画像では、２つのエンティティを繋いでいる線にあたる。  
・どのようなリレーションであるかは、カーディナリティを使って表現する。  
<br>

### アトリビュート（属性）

・エンティティの中のデータの属性情報や項目。  
・上の画像では、「顧客 ID」「顧客名称」「住所」「電話番号」にあたる。  
・主キーになる項目に「PK」と記述する  
・設計をして粒度が細かくなっていくほど、主キーや外部キーなどのカラムの詳細情報と同義。
<br>

## カーディナリティの書き方

IE 記法
「○」「l」「鳥の足（3 つ股の線）」という３つの記法を組み合わせて表現する  
<br>
<img src="img/IE記法.png" width="300px">
<br>

- １対１
  <br>
  <img src="img/1vs1.png">
  <br>

- １または 0 対 N（0 以上）
  <br>
  <img src="img/1or0vsN.png">
  <br>

- １対 N（１以上）
  <br>
  <img src="img/1vsN.png">
  <br>

- N（０以上）対 N
  <br>
  <img src="img/NvsN.png">
  <br>

## ＥＲ図の書き方

ＥＲ図を書くためには、システム要件が明確になっていることが前提のため、先にユースケース図を記述する。  
<br>

1. エンティティの洗い出し  
   どのようなテーブルが必要になるかを考えながら洗い出す  
   ユースケース図のアクターやユースケースが値する  
   <br>

2. アストリビュートを洗い出す  
   それぞれのエンティティに必須のアストリビュートから考えていく  
   どのようなカラムが必要かを考えながら洗い出す  
   <br>

3. ＥＲ図に落とし込む  
   リレーションや主キー、外部キーを設定し、ＥＲ図に落とし込む。  
   アストリビュートが多いものから記述していき、見やすくなるようにエンティティを配置する。

<br>
<img src="img/ER作成手順.png">
<br>

※一般的にテーブル名、カラム名には英語（スネークケース）を使う。
