---
tags:
  - DB
---

# データベース管理システム

- 「データベース」＝データを保存する場所
- 「データベース管理システム」＝データベースを管理するシステムの部分

<br>

## データベース管理システムの役割

- データベースを操作するための言語を提供する
- データの整合性を保証した管理手段を提供する
- データ利用の標準化を行い、各種プログラムへのインターフェイスを提供する
- データへのアクセス制限を管理する
- 複数ユーザーの同時処理に対応する  
  ※アプリケーション上のデータ管理はデータベース管理システムが必要
  <br>

## データベース管理システムの種類

| 分類  | メリット                                     | デメリット                                   |
| ----- | -------------------------------------------- | -------------------------------------------- |
| RDBMS | > データの整合性が保てる                     | > データの整合性を保つ代わりに処理が遅くなる |
|       | > 複雑なデータの扱いが容易                   | > 仕様変更へ柔軟性が低い                     |
| NoSQL | > RDBMS を超えるパフォーマンスを誇る         | > データの整合性を保てない                   |
|       | > 大規模なデータや多種多様なデータに対応可能 | > データの加工が難しい                       |

※整合性＝情報の正確性と有効性  
不正確な情報は、ソフトウェアウイルスのリスクが高まる。  
<br>

## RDBMS

Excel のように列と行からなる２次元の表形式でデータを管理する。  
表のことを「テーブル」と呼ぶ。  
一つ一つのマスにデータを保存する。  
一つのデータベースの中に複数のテーブルを保存できる。  
|単語| 説明|
|----|-----|
|カラム |テーブルの列を指す。またデータの種類やデータ型を指す場合もある|
|レコード |テーブルの行で表され、データそのものを指す。「レコード数 = データ数」|
|フィールド |Excel でいうところの「セル」をフィールドと呼ぶ。フィールドには一つの値しか保存ができない|
RDBMS は SQL（言語）を活用して操作する  
<br>

### RDBMS の種類

| RDBMS      | 特徴                                                                                           |
| ---------- | ---------------------------------------------------------------------------------------------- |
| MySQL      | Oracle 社が開発した「処理が早い、拡張性と柔軟性が高い」世界一のシェアを誇る RDBMS              |
| MariaDB    | MySQL から派生した高性能で金融系業界から一般的なアプリケーションまで幅広く使用されている RDBMS |
| SQLServer  | Microsoft 社が開発した「WindowsOS との相性の良い」RDBMS                                        |
| PostgreSQL | 高い信頼性、とても丈夫で、パフォーマンスの高い RDBMS                                           |
| SQLite     | 小さく軽量で早く、データ型を指定しない RDBMS                                                   |

<br>

## SQL

SQL はデータベースに対して、データの検索、作成、編集、削除などの操作が可能。  
「標準 SQL」＝国際的に認められた企画で開発された SQL  
<br>

### SQL の文法

- 文の最後にセミコロンをつける（ ; ）  
  １度の操作に対して１つの SQL 文を記述する。  
  `SELECT * FROM users;`  
  <br>

- 大文字と小文字の区別がない  
  「キーワード」＝ SQL が出す具体的なデータベースへの命令  
  キーワード　＝＞　大文字小文字区別なし  
  データ　＝＞　区別なし  
  <br>

- 文字列はシングルクォーテーションで囲む  
  データとして指定する文字列は「''」で囲む
- 単語は半角スペースで区切る

<br><br>

# データベースセットアップ

## ディレクトリ作成

```
database
├── docker
│   └── mysql
│       ├── data
│       └── my.cnf
└── docker-compose.yml
```

| ディレクトリ/ファイル | 説明                                                           |
| --------------------- | -------------------------------------------------------------- |
| docker-compose.yml    | docker-compose の設定を記述するファイル                        |
| docker                | 必要なソフトウエアそれぞれの設定ファイルを格納するディレクトリ |
| mysql                 | mysql の設定ファイルを格納するディレクトリ                     |
| data                  | データベースに必要なソフトウエアが自動で格納されるディレクトリ |
| my.cnf                | データベースで使用される文字などの設定ファイル                 |

<br>

## my.conf ファイルの作成

文字や時間を指定している

```
[mysqld]
# サーバの文字コードをutf8にする
character-set-server = utf8mb4

# アルファベットの大文字・小文字を区別するなどの設定
collation-server = utf8mb4_unicode_ci

# タイムゾーンの設定
default-time-zone = 'Asia/Tokyo'

[mysql]
default-character-set=utf8mb4

[client]
default-character-set=utf8mb4
```

| 用語   | 説明                       |
| ------ | -------------------------- |
| mysqld | mysql サーバへの設定       |
| mysql  | mysql グループへの設定     |
| client | mysql クライアントへの設定 |

それぞれに対して文字の設定をしている
<br>

## docker-compose.yml の作成

```
version: '3.8'

services:
    mysql:
        image: mysql:8.0.26
        environment:
            MYSQL_ROOT_PASSWORD: password
            MYSQL_DATABASE: first_db
            MYSQL_USER: first_user
            MYSQL_PASSWORD: first_pass
        command:
            mysqld --default-authentication-plugin=mysql_native_password
        volumes:
            - ./docker/mysql/data:/var/lib/mysql
            - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
```

| 項目                | 説明                         |
| ------------------- | ---------------------------- |
| MYSQL_ROOT_PASSWORD | 管理者パスワードの設定       |
| MYSQL_DATABASE      | データベースの初期設定       |
| MYSQL_USER          | 一般ユーザの初期設定         |
| MYSQL_PASSWORD      | 一般ユーザのパスワードの設定 |

MYSQL_ROOT_PASSWORD は管理者ユーザーのパスワード  
最初にアクセスするときに必要になる
<br>
|ボリュームのパス| docker 側のディレクトリ|
|--------------|-----------------------|
|./docker/mysql/data |/var/lib/mysql|
|./docker/mysql/my.cnf| /etc/mysql/conf.d/my.cnf|
ローカルのディレクトリと docker 内のディレクトリを接続している  
<br>

## Docker の起動

database ディレクトリで以下コマンド実行
`$ docker-compose up -d`  
`$ docker-compose exec mysql bash`  
以下が表示されていれば成功  
`root@1fe95554c536:/#`

<br>

## mysql へのアクセス

MySQL は Linux 上ではなく、Docker コンテナの中で動いているため、  
コンテナの中に入ってから操作。  
<br>

root（管理者）ユーザーでログイン  
`root@1fe95554c536:/# mysql -u root -p`  
MYSQL_ROOT_PASSWORD で設定した pw でログイン
<br>

一般ユーザーでログイン  
`$ mysql -u first_user -p`  
MYSQL_PASSWORD で設定した pw でログイン  
<br>

```
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 10
Server version: 8.0.27 MySQL Community Server - GPL

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
```

<br>

### mysql の終了

`mysql> exit;`  
MySQL で使う SQL は、必ず文末に「;」がつく。  
Docker のコンテナ環境に戻って来られれば成功  
`root@1fe95554c536:/#`

<br><br>

# データベースとテーブルの構築

データベース作成手順

1. データベースの作成
2. テーブルの作成
3. データの作成
   ※root ユーザーとして MySQL にログインして実行していく
   <br>

## データベースの作成

`> CREATE DATABASE データベース名;`  
成功したときの出力  
`Query OK, 1 row affected (0.40 sec)`

<br>

### データベース一覧の確認

`> SHOW databases;`  
出力

```
+--------------------+
| Database           |
+--------------------+
| first              |　#今回作成したデータベース
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
```

デフォルトで作成されているデータベースがいくつかあるが、  
今回作成したデータベースが追加されていれば成功。  
<br>

### 使用するデータベースの選択

テーブルを使用するには、データベースを選択する必要がある。  
`> USE データベース名;`  
成功したときの出力  
`Database changed`

<br>

使用しているデータベースの確認  
`> SELECT database();`  
出力

```
+------------+
| database() |
+------------+
| first      |
+------------+
1 row in set (0.13 sec)
```

<br>

## テーブルの作成

`> CREATE TABLE テーブル名（カラム名 データ型 制約）;`  
成功したときの出力  
`Query OK, 0 rows affected (0.98 sec)`

複数のカラムを設定するとき

```
> CREATE TABLE テーブル名 (
カラム名1 データ型 制約,
カラム名2 データ型 制約,
カラム名3 データ型 制約
);
```
<br>

### テーブル名

可能な限り複数形の英単語を利用する  
「格納する情報 複数形」で検索すると出てくる

| 格納する情報 | テーブル名 |
| ------------ | ---------- |
| 会員情報     | users      |
| 社員情報     | staff      |
| 商品情報     | products   |

<br>

### データ型

格納する情報の種類

| 分類名       | データ型  | 説明                                                                            |
| ------------ | --------- | ------------------------------------------------------------------------------- |
| 整数型       | INT       | 整数全般を扱う。                                                                |
| 整数型       | BIGINT    | INT 型より広い範囲の整数値を扱える                                              |
| 文字列型     | CHAR      | 固定の文字列を扱う。指定した文字数以下の時は自動でその分の空白を埋める          |
| 文字列型     | VARCHAR   | 可変の文字列を扱う。指定した文字数以下の時は CHAR 型と異なり、空白を埋めない。  |
| 浮動小数点型 | FLOAT     | 少数を扱うデータ型。約 7 桁の少数まで正確に扱える。                             |
| 浮動小数点型 | DOUBLE    | 約 15 桁の少数まで正確に扱えるデータ型。その分 FLOAT よりデータのサイズは大きい |
| 論理型       | BOOLEAN   | true または false の 2 種類のみを扱う。                                         |
| 日付型       | DATETIME  | 日付と時刻を扱うデータ型。'YYYY-MM-DD HH:MM:SS' が基本の形                      |
| 日付型       | TIMESTAMP | DATETIME 型と日付と時刻を扱うデータ型であるが、データの範囲などが異なる         |

<br>

### 制約

データの整合性を保つために活用するもの

| 制約           | 説明                                                                                   |
| -------------- | -------------------------------------------------------------------------------------- |
| NOT NULL       | データを追加・更新する際に NULL を許容しない制約                                       |
| UNIQUE         | データを追加・更新する際にデータが一意（他と重複しない）でなければならない制約         |
| PRIMARY KEY    | 該当のカラムを主キーに指定する制約                                                     |
| FOREIGN KEY    | 該当のカラムを外部キーに指定する制約                                                   |
| DEFAULT        | カラムにデフォルトの値を設定することができる制約                                       |
| CHECK          | データを追加・更新する際にカラムの条件を設定することができる制約                       |
| AUTO_INCREMENT | カラムに登録されたデータに自動で値を増やしていく制約。自動で連番をつけることができる。 |

<br>

## テーブルの一覧を表示する

現在使用しているデータベースのテーブル一覧を表示  
`> SHOW tables;`

成功したときの出力

```
+------------------+
| Tables_in_first  |
+------------------+
| users            |
+------------------+
1 row in set (0.00 sec)
```

<br>

## テーブルの詳細を確認する方法

`> SHOW COLUMNS FROM テーブル名;` # テーブル users を確認

成功したときの出力

```
+-------+-------------+------+-----+---------+-------+
| Field | Type        | Null | Key | Default | Extra |
+-------+-------------+------+-----+---------+-------+
| id    | int         | NO   | PRI | NULL    |       |
| name  | varchar(10) | NO   |     | NULL    |       |
| age   | int         | NO   |     | NULL    |       |
+-------+-------------+------+-----+---------+-------+
3 rows in set (0.02 sec)
```

<br><br>

# データ操作の基本

## CRUD（クラッド）

システムに必要な４つの主要機能の頭文字を並べた言葉

- CREATE（作成）
- READ（参照）
- UPDATE（参照）
- DELETE（削除）

<br>

## データの作成（CREATE）

`> INSERT INTO テーブル名 (カラム名) VALUES (値);`

成功したときの出力  
`Query OK, 1 row affected (0.18 sec)`

複数のカラムのデータの場合  
`> INSERT INTO テーブル名 (カラム名１, カラム名２, カラム名３) VALUES (値１, 値２, 値３);`

<br>

## 複数のデータの挿入

`> INSERT INTO テーブル名 (カラム名) VALUES (データ１), (データ２), (データ３);`

成功したときの出力

```
Query OK, 6 rows affected (0.17 sec)
Records: 6  Duplicates: 0  Warnings: 0
```

()の外に,がつく  
<br>
複数のカラムの挿入と組み合わせ可能

```
> INSERT INTO テーブル名 (カラム名1, カラム名2, カラム名3)
                VALUES (値1, 値2, 値3),
                        (値1, 値2, 値3),
                        (値1, 値2, 値3);
```

<br>

## データ一覧を参照（READ）

指定したカラムのデータ一覧を表示  
`> SELECT カラム名 FROM テーブル名;`

全てのカラム（_）のデータ一覧を表示  
`> SELECT * FROM テーブル名;` #テーブル名に users を指定

成功したときの出力

```
+------+--------+------+
| id   | name   | age  |
+------+--------+------+
|    1 | Taro   |   24 |
|    2 | Jiro   |   28 |
|    3 | Saburo |   33 |
|    4 | Shiro  |   24 |
|    5 | Goro   |   27 |
|    6 | Rokuro |   87 |
|    7 | Nanaro |   66 |
+------+--------+------+
7 rows in set (0.00 sec)
```

<br>

## データの削除（DELETE）

テーブル内の全てのデータを削除  
`> DELETE FROM テーブル名;`

一部のデータを削除  
`> DELETE FROM テーブル名 WHERE カラム名=値;`  
※指定した値だけでなく、データ自体が消える  
age=27 を指定すると、(5, 'Goro', 27)が消える  
<br>

## データの更新（UPDATE）

全ての値を更新  
`> UPDATE テーブル名 SET カラム名=値;`

一部の値を更新  
`> UPDATE テーブル名 SET カラム名=変更後の値 WHERE カラム名=変更する値;`

更新する＝編集する  
<br>

## データベース/テーブルの削除

### テーブルの削除

`> DROP TABLE テーブル名;`

成功したときの出力  
`Query OK, 0 rows affected (0.49 sec)`

<br>

### データベースの削除

`> DROP DATABASE データベース名;`

成功したときの出力  
`Query OK, 0 rows affected (0.49 sec)`
