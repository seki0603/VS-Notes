1. テーブル作成
2. トップページ作成
3. カテゴリ一覧ページ作成
4. カテゴリの追加機能実装
5. カテゴリの更新・削除機能実装
6. 追加・検索機能実装
   <br>

※１つのテーブルを持つ、既に CRUD 機能を実装したアプリに、リレーションを持つテーブルのデータと、キーワード検索を実装する。
<br>

# テーブル作成

1. 新規テーブル作成
2. 作成済みテーブルの編集
3. リレーションを持つテーブルのマイグレーション
4. モデルの作成

リレーションを持つ下記 2 つのテーブルを作成

- todos テーブル

  | カラム名    | 型              | 説明                     |
  | ----------- | --------------- | ------------------------ |
  | id          | unsigned bigint | 主キー                   |
  | category_id | unsigned bigint | 外部キー                 |
  | content     | string          | Todo の内容(20 文字以内) |
  | created_at  | timestamp       | レコード作成時刻         |
  | updated_at  | timestamp       | レコード更新時刻         |

  <br>

- categories テーブル

  | カラム名   | 型              | 説明                    |
  | ---------- | --------------- | ----------------------- |
  | id         | unsigned bigint | 主キー                  |
  | name       | string          | カテゴリ名(10 文字以内) |
  | created_at | timestamp       | レコード作成時刻        |
  | updated_at | timestamp       | レコード更新時刻        |

  <br>

## 新規テーブル作成

マイグレーションファイル作成  
`php artisan make:migration create_テーブル名（複数形）_table`  
<br>

作成したマイグレーションファイルに記述

```
public function up()
{
    Schema::create('categories', function (Blueprint $table) {
        $table->id();
+       $table->string('name', 10)->unique();
        $table->timestamps();
    });
}
```

- name カラムに重複を防ぐために unique を指定
  <br>

## 作成済みテーブルの編集

todos テーブルに外部キーである category キーを追加

```
public function up()
{
    Schema::create('todos', function (Blueprint $table) {
        $table->id();
+       $table->foreignId('category_id')->constrained()->cascadeOnDelete();
        $table->string('content', 20);
        $table->timestamps();
    });
}
```

| メソッド                 | 説明                                                                 |
| ------------------------ | -------------------------------------------------------------------- |
| foreignId('category_id') | 外部 IDcategory_id を設定                                            |
| constrained()            | laravel の規約に則り、自動でテーブルを紐づけてくれる                 |
| cascadeOnDelete()        | 参照先の id が削除された時に、その外部 id を持つレコードも削除される |

<br>

## リレーションを持つテーブルのマイグレーション

リレーションのテーブルは下記の順番でマイグレーションしないとエラーになる

1. リレーションの元となるテーブル
2. 外部キーを持つテーブル

マイグレーションはファイル名先頭の作成日順で実行されるため、ファイル名を変更してマイグレーション順を調整する。  
<br>

一度マイグレートしている従テーブルをロールバック  
`php artisan migrate:rollback --step=1`  
(1 つ前のマイグレート取り消すコマンド)

マイグレーション  
`php artisan migrate`

もしくは`php artisan migrate:fresh`  
(ロールバックするまでもなく全テーブルの全データが削除される)  
<br>

## モデルの作成

### 主テーブルを扱うモデルを作成

`php artisan make:model モデル名(先頭大文字)`

作成したモデルを記述し、操作可能にする。

```
class Category extends Model
{
    use HasFactory;

+   protected $fillable = ['name'];
}
```

<br>

### 従テーブルのモデルを修正し、リレーションを設定。

```
 protected $fillable = [
+       '外部キー',
        'content'
    ];

+   public function category()
+   {
+       return $this->belongsTo(主テーブルのモデル::class);
+   }
```

- `$fillable`で外部キーを操作可能に
- belongsTo メソッドで外部キーに関連付いているレコードを取り出す。

<br><br>

# トップページ作成

画面仕様を確認し、検索欄、検索ボタン、テーブルのカテゴリ表示などを追加。  
ヘッダーにカテゴリ一覧へのリンク追加。

カテゴリのセレクトボックス

```
<select class="search-form__item-select">
  <option value="">カテゴリ</option>
</select>
```

<br>

css でセレクトボックスのプルタブを非表示に

```
.create-form__item-select, .search-form__item-select {
+   padding: 10px;
+   width: 30%;
+   height: 40px;
+   border: 1px solid #ddd;
+   border-radius: 3px;
+   appearance: none;
+ }
```

<br><br>

# カテゴリ一覧ページ作成

1. コントローラ作成
2. ルーティング設定
3. View ファイル作成
   <br>

## コントローラ作成

カテゴリ一覧ページを表示するため、コントローラ作成。  
`php artisan make:controller コントローラ名（アッパーキャメル）`

| HTTP メソッド | ルートパス  | 実行するコントローラ | アクション |
| ------------- | ----------- | -------------------- | ---------- |
| GET           | /categories | CategoryController   | index      |

<br>

index アクションで一覧ページを呼び出す処理を記述
モデルをインポート

```
namespace App\Http\Controllers;

+ use App\Models\モデル名;
use Illuminate\Http\Request;

class CategoryController extends Controller
{
+     public function index()
+     {
+         $変数（複数形） = モデル名::all();

+         return view('category', compact('定義した変数'));
+     }
}
```

- モデルを用いてテーブルの値を全て取得し、変数に格納。
- 一覧ページを呼び出し、格納された値を送信。
  <br>

## ルーティング設定

`use App\Http\Controllers\CategoryController;`  
`Route::get('/categories', [CategoryController::class, 'index']);`

- use 文でコントローラの読み込み
  <br>

## View ファイル作成

画面仕様を確認し、カテゴリ一覧ページを作成。

```
<table class="category-table__inner">
      <tr class="category-table__row">
        <th class="category-table__header">category</th>
      </tr>
      @foreach ($categories as $category)
      <tr class="category-table__row">
        <td class="category-table__item">
          <form class="update-form">
            <div class="update-form__item">
              <input class="update-form__item-input" type="text">
            </div>
            <div class="update-form__button">
              <button class="update-form__button-submit" type="submit">更新</button>
            </div>
          </form>
        </td>
        <td class="category-table__item">
          <form class="delete-form">
            <div class="delete-form__button">
              <button class="delete-form__button-submit" type="submit">削除</button>
            </div>
          </form>
        </td>
      </tr>
      @endforeach
    </table>
```

- @extends ディレクティブで親レイアウト読み込み
- フラッシュメッセージ等はトップページから使いまわせる
- @foreach ディレクティブでテーブル row をカテゴリの数だけ表示するように記述

http://localhost にアクセスし、トップページとカテゴリ一覧ページが表示されているか、ヘッダーのリンクが正常か確認。

<br><br>

# カテゴリの追加機能実装

1. ルーティングの設定
2. view から controller への値の送信
3. 追加機能作成
4. バリデーション実装
   <br>

## ルーティングの設定

| HTTP メソッド | ルートパス  | 実行するコントローラ | アクション |
| ------------- | ----------- | -------------------- | ---------- |
| POST          | /categories | CategoryController   | store      |

<br>

`Route::post('/categories', [CategoryController::class, 'store']);`  
<br>

## view から controller への値の送信

form タグ修正

```
+ <form class="create-form" action="/categories" method="post">
+     @csrf
<div class="create-form__item">
+         <input class="create-form__item-input" type="text" name="name">
</div>
<div class="create-form__button">
<button class="create-form__button-submit" type="submit">作成</button>
</div>
</form>
```

- action と method を指定
- @csrf の付け忘れに注意
- name 属性にキー（カラム名）を指定
  <br>

## 追加機能作成

### コントローラに store アクションを記述

```
public function store(Request $request)
{
  $変数（単数形） = $request->only(['キー']);
  モデル名::create($変数);

  return redirect('/categories')->with('message', 'カテゴリを作成しました');
}
```

- 送信されたキーを変数に格納
- create メソッドでレコードを作成
- リダイレクト時にフラッシュメッセージが出るように記述
  <br>

### 追加したカテゴリが表示されるように blade ファイル修正

```
<div class="update-form__item">
+   <input class="update-form__item-input" type="text" value="{{ $category['name'] }}">
  </div>
```

- input の value を`{{ $変数['キー'] }}`に変更

http://localhost/categories にアクセスし、カテゴリが追加できるか確認。  
<br>

## バリデーション実装

### フォームリクエストを作成

`php artisan make:request フォーム名（アッパーキャメル）`  
<br>

作成されたフォームリクエストを編集し、バリデーションを実装。  
エラーメッセージを指定

```
public function rules()
{
return [
            'name' => ['required', 'string', 'max:10', 'unique:categories'],
];
}

     public function messages()
     {
         return [
             'name.required' => 'カテゴリを入力してください',
             'name.string' => 'カテゴリを文字列で入力してください',
             'name.max' => 'カテゴリを10文字以下で入力してください',
             'name.unique' => 'カテゴリが既に存在しています',
         ];
     }
```

- authorize を true に変更
- `キー => [制約１, 制約２,]`でルールを設定
- `unique:テーブル名`で重複を禁止
- `'キー.制約' => 'メッセージ内容'`でエラーメッセージを指定
  <br>

### 入力失敗時の値を保持(表示)できるように View ファイルを編集

```
<form class="create-form" action="/categories" method="post">
@csrf
<div class="create-form__item">
+         <input class="create-form__item-input" type="text" name="name" value="{{ old('name') }}">
</div>
<div class="create-form__button">
<button class="create-form__button-submit" type="submit">作成</button>
</div>
</form>
```

- value に`{{ old('キー') }}`を指定
  <br>

### フォームリクエストをコントローラで反映

```
+ use App\Http\Requests\CategoryRequest;

// 中略

+ public function store(CategoryRequest $request)
{
  $category = $request->only(['name']);
  Category::create($category);

  return redirect('/categories')->with('message', 'カテゴリを作成しました');
}
```

- use 文でフォームリクエストを読み込み
- Request を CategoryRequest に編集

ブラウザでエラーが表示されるか確認
<br>

# カテゴリの更新・削除機能実装

1. 更新機能の実装
2. 削除機能の実装
   <br>

## 更新機能の実装

| HTTP メソッド | ルートパス         | 実行するコントローラ | アクション |
| ------------- | ------------------ | -------------------- | ---------- |
| PATCH         | /categories/update | CategoryController   | update     |

### フォームの内容をコントローラに送るために View ファイルを編集

```
+ <form class="update-form" action="/categories/update" method="post">
+     @method('PATCH')
+     @csrf
<div class="update-form__item">
+     <input class="update-form__item-input" type="text" name="name" value="{{ $category['name'] }}">
+     <input type="hidden" name="id" value="{{ $category['id'] }}">
</div>
```

- フォームの action を記述
- form の method に post、@method ディレクティブに patch を指定
- @csrf の付け忘れに注意
- input の value に`{{ $変数['キー'] }}`を指定
- name 属性にキー（カラム名）を指定
- hidden 属性の input タグで id を送信
  <br>

### コントローラに update アクションを追加

```
public function update(CategoryRequest $request)
{
  $category = $request->only(['name']);
  Category::find($request->id)->update($category);

  return redirect('/categories')->with('message', 'カテゴリを更新しました');
}
```

- `$変数`に取得した値を格納
- find メソッドで form から送信された id で検索し、update。
- リダイレクト時にフラッシュメッセージを表示
  <br>

### ルーティングを設定

`Route::patch('/categories/update', [CategoryController::class, 'update']);`  
<br>

## 削除機能の実装

| HTTP メソッド | ルートパス         | 実行するコントローラ | アクション |
| ------------- | ------------------ | -------------------- | ---------- |
| DELETE        | /categories/delete | CategoryController   | destory    |

### フォームから id をコントローラに送れるように View ファイルを編集

```
+ <form class="delete-form" action="/categories/delete" method="post">
+   @method('DELETE')
+   @csrf
<div class="delete-form__button">
+       <input type="hidden" name="id" value="{{ $category['id'] }}">
<button class="delete-form__button-submit" type="submit">削除</button>
</div>
</form>
```

- form タグの method に post、@method ディレクティブに delete を指定。
- @csrf の付け忘れに注意
- hidden 属性の input で id を送信
  <br>

### コントローラに destroy アクションを作成

```
public function destroy(Request $request)
{
  Category::find($request->id)->delete();

  return redirect('/categories')->with('message', 'カテゴリを削除しました');
}
```

- find メソッドで id を取得し、delete メソッドで削除。
- リダイレクト時にフラッシュメッセージを表示
  <br>

### ルーティングを設定

`Route::delete('/categories/delete', [CategoryController::class, 'destroy']);`  
<br>

http://localhost/categories にアクセスし、実際に削除できるか確認。

<br><br>

# 追加・検索機能実装

1. カテゴリと結びつけた Todo の追加
2. モデルを利用した検索処理の作成
3. 検索機能の実装
   <br>

## カテゴリと結びつけた Todo の追加

### Todo に紐づくカテゴリを、トップページに表示する処理を TodoController に記述

```
use App\Http\Requests\TodoRequest;
+ use App\Models\Category;
use App\Models\Todo;
use Illuminate\Http\Request;

class TodoController extends Controller
{
public function index()
{
+       $todos = Todo::with('category')->get();
+       $categories = Category::all();

+       return view('index', compact('todos', 'categories'));
}
}
```

- `モデル::with('モデルで作成したメソッド')->get()`でテーブルの情報と、それに紐づくテーブルの情報をまとめて取得できる。
- index に外部テーブルの情報を格納した変数も返すように記述
  <br>

### View ファイルのセレクトボックスを修正

```
<select class="create-form__item-select" name="category_id">
    <option value="">カテゴリ</option>
+  @foreach ($categories as $category)
+   <option value="{{ $category['id'] }}">
      {{ $category['name'] }}
    </option>
+  @endforeach
</select>
```

- @foreach ディレクティブでカテゴリの数だけ表示されるように修正
- value に`{{ $変数['id'] }}`で外部キーを指定
- 表示内容は`{{ $変数['キー'] }}`
- 上に option タグを追加すると初期表示を決められる
  <br>

ブラウザで表示を確認
<br>

### コントローラを設定

外部キーと content の内容をデータベースに保存するよう、store アクションを修正。

```
public function store(TodoRequest $request)
{
-     $todo = $request->only(['content']);
+     $todo = $request->only(['category_id', 'content']);
  Todo::create($todo);
  return redirect('/')->with('message', 'Todoを作成しました');
}
```

- 変数に格納するデータに外部キーを追加
  <br>

追加されたカテゴリが View のテーブル内に表示されるように修正

```
<div class="update-form__item">
+     <p class="update-form__item-p">{{ $todo['category']['name'] }}</p>
</div>
```

- `$todo['category']['name']`≒`$todo->category->name`  
  todo テーブル->外部テーブル categories のレコード->そのレコードの name カラム  
  上記のようなアクセス手順を表示内容にしている  
  <br>

## モデルを利用した検索処理の作成

| HTTP メソッド | ルートパス    | 実行するコントローラ | アクション |
| ------------- | ------------- | -------------------- | ---------- |
| GET           | /todos/search | TodoController       | search     |

<br>

### 検索欄のセレクトボックスを編集

```
+ <form class="search-form" action="/todos/search" method="get">
+ @csrf
  <div class="search-form__item">
+   <input class="search-form__item-input" type="text" name="keyword"
    value="{{ old('keyword') }}">
+   <select class="search-form__item-select" name="category_id">
      <option value="">カテゴリ</option>
+     @foreach ($categories as $category)
+     <option value="{{ $category['id'] }}">
        {{ $category['name'] }}
      </option>
+     @endforeach
    </select>
  </div>
```

- form の action と method を指定
- @csrf の付け忘れに注意
- input の name 属性に keyword を指定
- option の value にリレーションテーブルの id、表示内容をカラム(=キー)に指定

http://localhost でカテゴリ表示を確認
<br>

### コントローラの修正

category_id と content の内容をデータベースに保存するように設定

```
public function store(TodoRequest $request)
{
-     $todo = $request->only(['content']);
+     $todo = $request->only(['category_id', 'content']);
  Todo::create($todo);
  return redirect('/')->with('message', 'Todoを作成しました');
}
```

- category_id もリクエストから取得して変数に格納するように編集
  <br>

### カテゴリ名の表示

```
  <div class="update-form__item">
-     <p class="update-form__itme-p">カテゴリー名</p>
+     <p class="update-form__itme-p">{{ $todo['category']['name'] }}</p>
  </div>
```

- p の表示内容をアクセス手順に編集
  <br>

## 検索機能の実装

| HTTP メソッド | ルートパス    | 実行するコントローラ | アクション |
| ------------- | ------------- | -------------------- | ---------- |
| GET           | /todos/search | TodoController       | search     |

<br>

### View ファイル編集

form タグとテキストボックスの部分から値が送れるように編集

```
+ <form class="search-form" action="/todos/search" method="get">
+  @csrf
    <div class="search-form__item">
+     <input class="search-form__item-input" type="text"
      name="keyword" value="{{ old('keyword') }}">
+     <select class="search-form__item-select" name="category_id">
        <option value="">カテゴリ</option>
+       @foreach ($categories as $category)
+       <option value="{{ $category['id'] }}">
          {{ $category['name'] }}
        </option>
+       @endforeach
      </select>
    </div>
```

- form の action と method を編集
- input の name に keyword を指定
- 入力した値を保持できるように value に old 関数を使用
- カテゴリを表示するためにセレクトボックス内を編集
  <br>

### ルーティング設定

`Route::get('/todos/search', [TodoController::class, 'search']);`  
<br>

## 検索機能の実装

ローカルスコープを使用  
「ローカルスコープ」＝ Eloquent モデルの中で SQL をメソッドとして定義できる機能  
コードの可読性を上げるために使用する  
<br>

### モデルの設定

```
public function scopeCategorySearch($query, $category_id)
{
  if (!empty($category_id)) {
    $query->where('category_id', $category_id);
  }
}

public function scopeKeywordSearch($query, $keyword)
{
  if (!empty($keyword)) {
    $query->where('content', 'like', '%' . $keyword . '%');
  }
}
```

- scopeCategorySearch で`$category_id`が空でなかった場合に検索を行う処理を記述
- scopeKeywordSearch で`$keyword`が空でなかった場合に content で検索を行う
- where メソッドで like を使用し、部分一致検索が出来るようにしている。
  ※`where('カラム名','like','%' . 検索内容 . '%');`  
  <br>

### コントローラでローカルスコープを使用

```
public function search(Request $request)
{
  $todos = Todo::with('category')->CategorySearch($request->category_id)->KeywordSearch($request->keyword)->get();
  $categories = Category::all();

  return view('index', compact('todos', 'categories'));
}
```

- scope 部分を除いたメソッド名を使用
- 2 つの検索結果を変数に格納
- compact で検索結果とカテゴリの値を index に送る
  <br>
