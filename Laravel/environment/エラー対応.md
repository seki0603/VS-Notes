# エラー対応

1. ログ確認
2. 設定確認・修正
3. キャッシュクリア
4. 再構築（最終手段）

## ログ確認

`docker logs コンテナID`  
<br>

## キャッシュクリア

.env を書き換えた場合、要キャッシュクリア  
`php artisan config:clear`  
`php artisan cache:clear`  
※その後、migrate などに再チャレンジ
<br>

## 最終手段

1. コンテナ停止  
   `docker-compose down`  
   <br>

2. MySQL の永続データ削除  
   `sudo rm -rf ./docker/mysql/data/*`  
   <br>

3. 再起動
   `docker-compose up -d`
   その後、migrate などに再チャレンジ  
    ※データは全部消える

<br><br>

# Permission(権限)エラー対策

<br>

Laravel が書き込み必要な部分だけ権限を緩める  
`sudo chmod -R 775 ディレクトリパス`

- 「777」＝誰でも読み書きできる
- 「775」＝所有者とグループのユーザーのみ読み書きできる
  <br>

## マイグレート時の接続エラー

エラー文  
`SQLSTATE[HY000]: General error: 1030 Got error 168 - 'Unknown (generic) error from engine'`  
<br>

権限確認  
`ls -ld docker/mysql/data`  
通常出力結果  
`drwxr-xr-x 7 999 systemd-journal 4096 Aug  8 10:42 docker/mysql/data`  
パーミッションが 999 になっていなければ修正  
<br>

修正コマンド  
`sudo chown -R 999:999 docker/mysql/data`  
<br>

## ログ出力中の権限エラー

1. Laravel のコンテナ ID を確認  
   `docker ps`  
   <br>

2. Laravel コンテナに入る  
   `docker exec -it コンテナID bash`  
   <br>

3. コンテナ内で sudo コマンド実行

```
chown -R www-data:www-data /var/www/storage
chmod -R 775 /var/www/storage
```

<br>

4. コンテナ再起動  
   `docker-compose restart`

<br><br>

# マイグレーション修正

## 修正の流れ

1. 該当マイグレーションの内容を修正
2. `php artisan migrate:rollback --step=1`（直前の１つだけ戻す）
3. `php artisan migrate`（再実行）
   <br>

## その他便利コマンド

| 目的                                       | コマンド例                                                               |
| ------------------------------------------ | ------------------------------------------------------------------------ |
| 直前の 1 つだけ取り消す                    | `php artisan migrate:rollback --step=1`                                  |
| 特定のマイグレーションだけ再実行           | `php artisan migrate:refresh --path=/database/migrations/xxx.php`        |
| 全部 1 回ずつ巻き戻す                      | `php artisan migrate:rollback`（複数回実行すれば順に戻る）               |
| 最後の〇件だけ実行を取り消す               | `php artisan migrate:rollback --step=3`（例：最後の 3 件）               |
| データは保持したままテーブル再作成（慎重） | `php artisan migrate:reset`（一括 down）+ `php artisan migrate`（再 up） |

<br>

どのマイグレーションが実行済みか確認できるコマンド  
`php artisan migrate:status`  
<br>

## 最終兵器

`php artisan migrate:fresh`  
実行すると全テーブルの全データが消し飛ぶ