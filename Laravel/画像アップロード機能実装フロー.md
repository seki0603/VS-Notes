# 画像アップロード機能実装フロー
## 前提
* 商品出品時にローカル端末から画像を選択・アップロードできるようにする。
* アップロードした画像はstorage/app/public配下に保存され、アプリ側から参照可能。

## マイグレーションファイル設計
画像アップロードを要するテーブルにカラムを追加  
`$table->string('image_path')->nullable();`  

* 実際の画像はstorage/app/public/productsに保存される。
* DBには相対パスのみ保存される。

## storage設定
### storageリンク作成
* 画像を公開フォルダから参照できるようにするための設定  
PHPコンテナ内で以下のコマンド実行  
`php artisan storage:link`

### 画像を格納するディレクトリを作成
`mkdir storage/app/public/products`

### Git追跡の調整
.gitignoreでstorageディレクトリごと追跡を外してある場合は、画像用ディレクトリをリモートに上げられるように編集が必要。  

* .gitignore(初期からプロジェクト直下にあるもの)
```
/node_modules
/public/hot
/public/storage
/storage/*.key
/vendor

// 以下略
```

* storage/app/.gitignore作成
```
*
!public/
!.gitignore
```

* storage/app/public/.gitignore作成
```
*
!.gitignore
!avatars/
!avatars/*.png
!avatars/*.jpg
!products/
!products/*.jpg
!products/*.png
```

## FormRequest作成
ExhibitionRequest.php
```
public function rules()
{
    return [
        'name' => ['required'],
        'brand_name' => ['nullable'],
        'description' => ['required', 'max:255'],
        'image' => ['required', 'image', 'mimes:jpeg,png'],
        'categories' => ['required', 'array', 'min:1'],
        'categories.*' => ['exists:categories,id'],
        'condition' => ['required', 'in:0,1,2,3'],
        'price' => ['required', 'integer', 'min:0'],
    ];
}
```
* 画像ファイルのみ許可
* 拡張子制限

## blade作成
sell.blade.php
```
<form class="form" action="{{ route('sell.store') }}" method="POST" enctype="multipart/form-data" novalidate>
    @csrf
    {{-- 画像アップロード --}}
    <p class="form__image-title">商品画像</p>
    <div class="form__image-wrapper">
        <div class="form__image" id="image-container">
            <input id="image" type="file" name="image" hidden>
            <label class="form__image-button" for="image" id="image-label">画像を選択する</label>
            <div class="form__image-preview" id="image-preview"></div>
        </div>
        <button class="form__reset-button" type="button" id="reset-button" style="display: none">画像を選び直す</button>
        @error('image')
            <p class="error">{{ $message }}</p>
        @enderror
    </div>
</form>
```
* formタグにenctype="multipart/form-dataを忘れずに設定
* name属性をバリデーションルールに合わせる
* プレビューを出す場合はJSのアンカーとしてid="image-preview"設定

### 必要に応じてJSでプレビュー機能実装
```
<script>
const input = document.getElementById('image');
const preview = document.getElementById('image-preview');
const label = document.getElementById('image-label');
const resetBtn = document.getElementById('reset-button');

input.addEventListener('change', function() {
    preview.innerHTML = '';
    if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            preview.appendChild(img);

            label.style.display = 'none';
            resetBtn.style.display = 'inline-block';
        }
        reader.readAsDataURL(this.files[0]);
    }
});

resetBtn.addEventListener('click', function(e) {
    e.preventDefault();
    input.value = '';
    preview.innerHTML = '';
    label.style.display = 'inline-block';
    resetBtn.style.display = 'none';
});
</script>
```

## ルーティング設定
```
Route::middleware(['auth', 'verified'])->group(function () {
    Route::get('/sell', [SellController::class, 'index'])->name('sell.index');
    Route::post('/sell', [SellController::class, 'store'])->name('sell.store');
});
```

## コントローラに画面表示と出品アクションを作成
SellController.php
```
use App\Models\Category;
use App\Models\Product;
use App\Http\Requests\ExhibitionRequest;
use Illuminate\Support\Facades\Auth;

public function index()
    {
        $categories = Category::all();
        return view('sell', compact('categories'));
    }

    public function store(ExhibitionRequest $request)
    {
        // storage/app/public/products に保存
        $path = $request->file('image')->store('products', 'public');

        // DB登録
        $product = Product::create([
            'seller_id' => Auth::id(),
            'name' => $request->name,
            'brand_name' => $request->brand_name,
            'price' => $request->price,
            'condition' => $request->condition,
            'description' => $request->description,
            'image_path' => $path, // パスを保存
        ]);

        $product->categories()->sync($request->categories);

        return redirect()->route('profile.index', ['page' => 'sell'])
            ->with('message', '商品を出品しました');
    }
```

ブラウザ上で確認可能
* DBにパスが保存されているか確認
* storage/app/public/productsに該当画像が保存されているか確認
